version: 2.1

# Use Nix Docker image for reproducible builds
executors:
  nix:
    docker:
      - image: nixos/nix:latest
    resource_class: medium

jobs:
  build:
    executor: nix
    steps:
      - checkout

      - run:
          name: Enable Nix flakes
          command: |
            mkdir -p ~/.config/nix
            echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - run:
          name: Build with Nix
          command: nix build .#default
          no_output_timeout: 20m

      - run:
          name: Compile in dev shell
          command: |
            nix develop --command sh -c '
              make clean || true
              make
            '
          no_output_timeout: 10m

      - run:
          name: Verify module count
          command: |
            nix develop --command sh -c '
              count=$(ls Transformer/*.vo 2>/dev/null | wc -l)
              echo "Compiled $count modules"
              if [ "$count" -ne 16 ]; then
                echo "Expected 16 modules, got $count"
                exit 1
              fi
              echo "All modules compiled successfully"
            '

      - run:
          name: Run flake check
          command: nix flake check

      - store_artifacts:
          path: Transformer
          destination: compiled-modules

  # Optional: extract OCaml and verify it compiles
  extract:
    executor: nix
    steps:
      - checkout

      - run:
          name: Enable Nix flakes
          command: |
            mkdir -p ~/.config/nix
            echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - run:
          name: Build and extract
          command: |
            nix develop --command sh -c '
              make
              ls -la extracted/*.ml 2>/dev/null || echo "Extraction files in project root"
              ls -la *.ml 2>/dev/null | head -10 || true
            '
          no_output_timeout: 15m

      - store_artifacts:
          path: extracted
          destination: ocaml-extraction

workflows:
  version: 2
  build-and-test:
    jobs:
      - build
      - extract:
          requires:
            - build
